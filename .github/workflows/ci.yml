name: CI

# Least-privilege permissions (CI-004)
permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # =============================================================================
  # TEMPLATE PROTECTION - Blocks forbidden files from being committed
  # =============================================================================
  template-guard:
    name: Template Protection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Block forbidden template files
        id: check-forbidden
        run: |
          echo "Checking for forbidden template files..."

          # Define forbidden patterns for the loa template repository
          # These files should NEVER be committed to the main loa template
          FORBIDDEN_FILES=(
            "grimoires/loa/prd.md"
            "grimoires/loa/sdd.md"
            "grimoires/loa/sprint.md"
            "grimoires/loa/NOTES.md"
            "grimoires/loa/ledger.json"
            "grimoires/loa/ledger.json.bak"
          )

          FORBIDDEN_DIRS=(
            "grimoires/loa/a2a/sprint-"
            "grimoires/loa/a2a/index.md"
            "grimoires/loa/a2a/deployment-feedback.md"
            "grimoires/loa/a2a/trajectory/"
            "grimoires/loa/deployment/"
            "grimoires/loa/reality/"
            "grimoires/loa/analytics/"
            "grimoires/loa/research/"
            "grimoires/pub/"
            ".claude/constructs/"
          )

          VIOLATIONS=()

          # Check for forbidden files
          for pattern in "${FORBIDDEN_FILES[@]}"; do
            if [ -f "$pattern" ]; then
              VIOLATIONS+=("$pattern")
            fi
          done

          # Check for forbidden directories/patterns
          for pattern in "${FORBIDDEN_DIRS[@]}"; do
            # Find any files matching the pattern (excluding README.md)
            while IFS= read -r file; do
              if [[ "$file" != *"/README.md" ]]; then
                VIOLATIONS+=("$file")
              fi
            done < <(find . -path "./$pattern*" -type f 2>/dev/null | head -50)
          done

          if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            echo ""
            echo "============================================================"
            echo "ERROR: Forbidden files detected in template repository!"
            echo "============================================================"
            echo ""
            echo "The following files must NOT be committed to the loa template:"
            echo ""
            for file in "${VIOLATIONS[@]}"; do
              echo "  - $file"
            done
            echo ""
            echo "These files are project-specific or contain licensed content and should be gitignored."
            echo "Note: .claude/constructs/ contains user-licensed skills that should never be committed."
            echo "If this is intentional, add [skip-template-guard] to commit message."
            echo "============================================================"
            exit 1
          fi

          echo "Template protection check passed - no forbidden files found"

      - name: Check for skip override
        if: failure() && contains(github.event.head_commit.message, '[skip-template-guard]')
        run: |
          echo "WARNING: Template guard bypassed via [skip-template-guard] in commit message"
          echo "This should only be used for exceptional circumstances!"

  # =============================================================================
  # FIXTURE SYNC - Ensures eval fixtures match source files
  # =============================================================================
  fixture-sync:
    name: Fixture Sync Check
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Check fixture drift
        run: bash evals/fixtures/sync-fixtures.sh --check

  validate:
    name: Validate Framework Files
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in $(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*"); do
            echo "Checking $file"
            python3 -m json.tool "$file" > /dev/null || { echo "Invalid JSON: $file"; exit 1; }
          done
          echo "All JSON files are valid"

      - name: Check skill definitions exist
        run: |
          echo "Checking required skill definitions..."
          SKILLS=(
            ".claude/skills/discovering-requirements/SKILL.md"
            ".claude/skills/designing-architecture/SKILL.md"
            ".claude/skills/planning-sprints/SKILL.md"
            ".claude/skills/implementing-tasks/SKILL.md"
            ".claude/skills/reviewing-code/SKILL.md"
            ".claude/skills/deploying-infrastructure/SKILL.md"
            ".claude/skills/auditing-security/SKILL.md"
            ".claude/skills/translating-for-executives/SKILL.md"
          )
          for skill in "${SKILLS[@]}"; do
            if [ ! -f "$skill" ]; then
              echo "Missing required skill: $skill"
              exit 1
            fi
          done
          echo "All required skills present"

      - name: Check command definitions exist
        run: |
          echo "Checking required command definitions..."
          # Note: setup.md removed in v0.15.0 - no longer required
          COMMANDS=(
            ".claude/commands/plan-and-analyze.md"
            ".claude/commands/architect.md"
            ".claude/commands/sprint-plan.md"
            ".claude/commands/implement.md"
            ".claude/commands/review-sprint.md"
            ".claude/commands/audit-sprint.md"
            ".claude/commands/deploy-production.md"
            ".claude/commands/audit.md"
            ".claude/commands/feedback.md"
            ".claude/commands/update-loa.md"
          )
          for cmd in "${COMMANDS[@]}"; do
            if [ ! -f "$cmd" ]; then
              echo "Missing required command: $cmd"
              exit 1
            fi
          done
          echo "All required commands present"

      - name: Check documentation exists
        run: |
          echo "Checking required documentation..."
          DOCS=(
            "README.md"
            "CLAUDE.md"
            "PROCESS.md"
            "CONTRIBUTING.md"
            "SECURITY.md"
            "CHANGELOG.md"
            "LICENSE.md"
          )
          for doc in "${DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "All required documentation present"

      - name: Validate version consistency
        run: |
          echo "Checking version consistency..."

          # Get version from CHANGELOG
          CHANGELOG_VERSION=$(grep -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1)
          echo "CHANGELOG version: $CHANGELOG_VERSION"

          # Get version from README badge
          README_VERSION=$(grep -oP 'version-\K[0-9]+\.[0-9]+\.[0-9]+' README.md | head -1)
          echo "README version: $README_VERSION"

          if [ "$CHANGELOG_VERSION" != "$README_VERSION" ]; then
            echo "Version mismatch: CHANGELOG=$CHANGELOG_VERSION, README=$README_VERSION"
            exit 1
          fi

          echo "Versions are consistent: $CHANGELOG_VERSION"

      - name: Validate constraint registry
        run: |
          echo "Validating DRY Constraint Registry..."
          bash .claude/scripts/validate-constraints.sh
          echo "Constraint validation passed"

      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links in documentation..."

          # Check that referenced files exist
          LINKS_OK=true

          for mdfile in README.md CLAUDE.md PROCESS.md CONTRIBUTING.md; do
            # Extract markdown links like [text](file.md) or [text](./path/file.md)
            # Use process substitution to avoid subshell variable scoping bug
            while read -r link; do
              # Skip external URLs and pure anchors
              if [[ "$link" == http* ]] || [[ "$link" == "#"* ]]; then
                continue
              fi

              # Strip anchor fragment before checking file existence
              local_path="${link%%#*}"

              # Check if file exists
              if [ ! -f "$local_path" ] && [ ! -d "$local_path" ]; then
                echo "Broken link in $mdfile: $link"
                LINKS_OK=false
              fi
            done < <(grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$mdfile" 2>/dev/null || true)
          done

          if [ "$LINKS_OK" = false ]; then
            exit 1
          fi

          echo "All internal links are valid"

  markdown-lint:
    name: Lint Markdown
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli@0.47.0

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": { "siblings_only": true }
          }
          EOF

      - name: Lint Markdown files
        run: markdownlint '**/*.md' --ignore node_modules --ignore grimoires/loa || true
        # Note: Using || true to not fail on lint warnings for now
        # Remove || true once all markdown is cleaned up

  yaml-lint:
    name: Lint YAML
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install yamllint
        run: pip install yamllint==1.38.0

      - name: Lint YAML files
        run: yamllint .github/ || true
        # Note: Using || true to not fail on lint warnings for now

  # =============================================================================
  # PATH-LIB ENFORCEMENT - Prevents hardcoded grimoire paths
  # =============================================================================
  path-lint:
    name: Check Hardcoded Paths
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Check for hardcoded grimoire paths
        run: |
          echo "Checking for hardcoded grimoire paths in scripts..."

          # Create allowlist file if it doesn't exist
          ALLOWLIST=".github/path-lint-allowlist.txt"
          if [ ! -f "$ALLOWLIST" ]; then
            # Default allowlist: path-lib.sh and test files
            echo ".claude/scripts/path-lib.sh" > /tmp/allowlist.txt
            echo ".claude/scripts/tests/" >> /tmp/allowlist.txt
            ALLOWLIST="/tmp/allowlist.txt"
          fi

          # Find all shell scripts with hardcoded grimoire paths
          VIOLATIONS=""
          while IFS= read -r -d '' file; do
            # Check if file is in allowlist
            skip=false
            while IFS= read -r pattern; do
              if [[ "$file" == *"$pattern"* ]]; then
                skip=true
                break
              fi
            done < "$ALLOWLIST"

            if $skip; then
              continue
            fi

            # Check for file-level pragma exemption
            if head -20 "$file" | grep -q "# path-lib: exempt"; then
              continue
            fi

            # Check for hardcoded paths (but not in comments)
            matches=$(grep -n "grimoires/loa" "$file" 2>/dev/null | grep -v "^[0-9]*:[[:space:]]*#" | grep -v "_DEFAULT_" || true)
            if [ -n "$matches" ]; then
              VIOLATIONS="$VIOLATIONS\n$file:\n$matches\n"
            fi
          done < <(find .claude/scripts -name "*.sh" -type f -print0)

          if [ -n "$VIOLATIONS" ]; then
            echo ""
            echo "============================================================"
            echo "WARNING: Hardcoded grimoire paths detected!"
            echo "============================================================"
            echo ""
            echo "The following scripts have hardcoded 'grimoires/loa' paths:"
            echo -e "$VIOLATIONS"
            echo ""
            echo "Scripts should use path-lib.sh getters instead:"
            echo "  source \"\$SCRIPT_DIR/bootstrap.sh\""
            echo "  LEDGER_FILE=\"\$(get_ledger_path)\""
            echo ""
            echo "To exempt a file, add '# path-lib: exempt' in first 20 lines."
            echo "============================================================"
            # Currently warning-only (Sprint 1), will become error in Sprint 2
            # exit 1
          else
            echo "No hardcoded path violations found."
          fi
