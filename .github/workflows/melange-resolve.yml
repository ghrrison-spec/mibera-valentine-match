name: Melange PR Resolution

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

jobs:
  detect-resolution:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'melange')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged)

    steps:
      - name: Process Resolution
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;

            if (event === 'issue_comment') {
              // Detect resolution patterns in comments
              const body = context.payload.comment.body;
              const issueNumber = context.payload.issue.number;

              // Patterns to detect PR references
              const patterns = [
                /resolved?\s+(?:via|in|by)\s+(?:PR\s*)?#(\d+)/i,
                /fixed?\s+(?:via|in|by)\s+(?:PR\s*)?#(\d+)/i,
                /addressed?\s+(?:via|in|by)\s+(?:PR\s*)?#(\d+)/i,
                /implemented?\s+(?:via|in|by)\s+(?:PR\s*)?#(\d+)/i,
                /closes?\s+(?:PR\s*)?#(\d+)/i
              ];

              for (const pattern of patterns) {
                const match = body.match(pattern);
                if (match) {
                  const prNumber = match[1];

                  // Check if label already exists
                  const existingLabels = context.payload.issue.labels.map(l => l.name);
                  const resolutionLabel = `resolution:PR#${prNumber}`;

                  if (!existingLabels.includes(resolutionLabel)) {
                    // Add resolution label
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      labels: [resolutionLabel]
                    });

                    console.log(`Linked PR #${prNumber} to Melange Issue #${issueNumber}`);

                    // Post confirmation comment
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      body: `ðŸ”— Linked to PR #${prNumber} for resolution tracking.`
                    });
                  }
                  break;
                }
              }
            }

            if (event === 'pull_request' && context.payload.pull_request.merged) {
              // Check if PR closes any Melange Issues
              const prBody = context.payload.pull_request.body || '';
              const prNumber = context.payload.pull_request.number;

              // Patterns for PR closing Issues
              const closesPatterns = [
                /closes?\s+#(\d+)/gi,
                /fixes?\s+#(\d+)/gi,
                /resolves?\s+#(\d+)/gi
              ];

              const closedIssues = new Set();

              for (const pattern of closesPatterns) {
                let match;
                while ((match = pattern.exec(prBody)) !== null) {
                  closedIssues.add(parseInt(match[1]));
                }
              }

              for (const issueNumber of closedIssues) {
                try {
                  // Check if it's a Melange Issue
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });

                  const labels = issue.data.labels.map(l => l.name);

                  if (labels.includes('melange')) {
                    // Update status to resolved
                    const newLabels = labels
                      .filter(l => !l.startsWith('status:'))
                      .concat(['status:resolved', `resolution:PR#${prNumber}`]);

                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      labels: newLabels
                    });

                    console.log(`Marked Melange Issue #${issueNumber} as resolved via PR #${prNumber}`);

                    // Post resolution comment
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      body: `âœ… Resolved via PR #${prNumber} (merged).`
                    });
                  }
                } catch (e) {
                  console.log(`Could not process Issue #${issueNumber}: ${e.message}`);
                }
              }
            }
