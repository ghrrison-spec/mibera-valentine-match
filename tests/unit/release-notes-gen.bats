#!/usr/bin/env bats
# Unit tests for release-notes-gen.sh
# Sprint 1 cycle-007: Release notes generation from CHANGELOG

setup() {
    BATS_TEST_DIR="$(cd "$(dirname "$BATS_TEST_FILENAME")" && pwd)"
    PROJECT_ROOT="$(cd "$BATS_TEST_DIR/../.." && pwd)"
    SCRIPT="$PROJECT_ROOT/.claude/scripts/release-notes-gen.sh"

    export BATS_TMPDIR="${BATS_TMPDIR:-/tmp}"
    export TEST_TMPDIR="$BATS_TMPDIR/release-notes-test-$$"
    mkdir -p "$TEST_TMPDIR"

    # Create isolated git repo for testing
    export TEST_REPO="$TEST_TMPDIR/repo"
    mkdir -p "$TEST_REPO/.claude/scripts"
    git -C "$TEST_REPO" init --quiet
    git -C "$TEST_REPO" config user.email "test@test.com"
    git -C "$TEST_REPO" config user.name "Test"

    # Copy bootstrap and the script to test repo
    cp "$PROJECT_ROOT/.claude/scripts/bootstrap.sh" "$TEST_REPO/.claude/scripts/"
    if [[ -f "$PROJECT_ROOT/.claude/scripts/path-lib.sh" ]]; then
        cp "$PROJECT_ROOT/.claude/scripts/path-lib.sh" "$TEST_REPO/.claude/scripts/"
    fi
    cp "$SCRIPT" "$TEST_REPO/.claude/scripts/"

    # Override PROJECT_ROOT for testing
    export PROJECT_ROOT="$TEST_REPO"

    # Use the test repo copy of the script
    TEST_SCRIPT="$TEST_REPO/.claude/scripts/release-notes-gen.sh"
}

teardown() {
    cd /
    if [[ -d "$TEST_TMPDIR" ]]; then
        rm -rf "$TEST_TMPDIR"
    fi
}

# =============================================================================
# Basic Tests
# =============================================================================

@test "release-notes: script exists and is executable" {
    [ -x "$SCRIPT" ]
}

@test "release-notes: shows help with --help" {
    run "$SCRIPT" --help
    [ "$status" -eq 0 ]
    [[ "$output" == *"release-notes-gen.sh"* ]]
}

@test "release-notes: requires --version" {
    run "$TEST_SCRIPT" --pr 42 --type cycle
    [ "$status" -eq 1 ]
    [[ "$output" == *"--version is required"* ]]
}

@test "release-notes: requires --pr" {
    run "$TEST_SCRIPT" --version 1.0.0 --type cycle
    [ "$status" -eq 1 ]
    [[ "$output" == *"--pr is required"* ]]
}

@test "release-notes: rejects unknown arguments" {
    run "$TEST_SCRIPT" --bogus
    [ "$status" -eq 1 ]
    [[ "$output" == *"Unknown argument"* ]]
}

# =============================================================================
# Cycle Release Tests
# =============================================================================

@test "release-notes: cycle type extracts CHANGELOG section" {
    cat > "$TEST_REPO/CHANGELOG.md" <<'EOF'
# Changelog

## [1.2.0] - 2026-02-13

### Added
- New feature A
- New feature B

### Fixed
- Bug fix C

## [1.1.0] - 2026-02-01

### Added
- Old feature
EOF

    run "$TEST_SCRIPT" --version 1.2.0 --pr 100 --type cycle
    [ "$status" -eq 0 ]
    [[ "$output" == *"What's New"* ]]
    [[ "$output" == *"New feature A"* ]]
    [[ "$output" == *"New feature B"* ]]
    [[ "$output" == *"Bug fix C"* ]]
    [[ "$output" == *"#100"* ]]
}

@test "release-notes: cycle type handles missing CHANGELOG version" {
    cat > "$TEST_REPO/CHANGELOG.md" <<'EOF'
# Changelog

## [1.0.0] - 2026-01-01

### Added
- Initial release
EOF

    run "$TEST_SCRIPT" --version 1.1.0 --pr 50 --type cycle
    [ "$status" -eq 0 ]
    [[ "$output" == *"No CHANGELOG section found"* ]]
    [[ "$output" == *"#50"* ]]
}

@test "release-notes: cycle type handles missing CHANGELOG file" {
    # No CHANGELOG.md in test repo
    run "$TEST_SCRIPT" --version 1.0.0 --pr 10 --type cycle
    [ "$status" -eq 0 ]
    [[ "$output" == *"No CHANGELOG section found"* ]]
    [[ "$output" == *"#10"* ]]
}

@test "release-notes: cycle output includes PR link" {
    run "$TEST_SCRIPT" --version 1.0.0 --pr 42 --type cycle
    [ "$status" -eq 0 ]
    [[ "$output" == *"PR: #42"* ]]
}

@test "release-notes: cycle output includes generation footer" {
    run "$TEST_SCRIPT" --version 1.0.0 --pr 42 --type cycle
    [ "$status" -eq 0 ]
    [[ "$output" == *"Generated by Loa Post-Merge Automation"* ]]
}

# =============================================================================
# Bugfix Release Tests
# =============================================================================

@test "release-notes: bugfix type generates minimal template" {
    run "$TEST_SCRIPT" --version 1.0.1 --pr 55 --type bugfix
    [ "$status" -eq 0 ]
    [[ "$output" == *"Bug Fix Release"* ]]
    [[ "$output" == *"#55"* ]]
}

@test "release-notes: bugfix type includes version in header" {
    run "$TEST_SCRIPT" --version 2.3.1 --pr 99 --type bugfix
    [ "$status" -eq 0 ]
    [[ "$output" == *"v2.3.1"* ]]
}

# =============================================================================
# Other Release Tests
# =============================================================================

@test "release-notes: other type uses CHANGELOG if available" {
    cat > "$TEST_REPO/CHANGELOG.md" <<'EOF'
# Changelog

## [1.5.0] - 2026-02-10

### Changed
- Refactored internals
EOF

    run "$TEST_SCRIPT" --version 1.5.0 --pr 77 --type other
    [ "$status" -eq 0 ]
    [[ "$output" == *"Release v1.5.0"* ]]
    [[ "$output" == *"Refactored internals"* ]]
}

@test "release-notes: other type falls back to maintenance release" {
    run "$TEST_SCRIPT" --version 1.0.0 --pr 33 --type other
    [ "$status" -eq 0 ]
    [[ "$output" == *"Maintenance release"* ]]
}

@test "release-notes: defaults to other type when unrecognized" {
    run "$TEST_SCRIPT" --version 1.0.0 --pr 33 --type something
    [ "$status" -eq 0 ]
    [[ "$output" == *"Release v1.0.0"* ]]
}
