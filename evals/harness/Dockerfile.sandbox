# Dockerfile.sandbox — Secure container image for Loa eval execution
# Pinned base image, minimal tools, non-root user, no network access
# Build: docker build -t loa-eval-sandbox -f evals/harness/Dockerfile.sandbox .
# Run:   docker run --rm --network none --memory 2g --cpus 2 --read-only \
#          --tmpfs /tmp:rw,noexec,size=512m \
#          -v "$(pwd)/workspace:/workspace:ro" \
#          -v "$(pwd)/results:/results:rw" \
#          loa-eval-sandbox

# Digest pinned 2026-02-11 via: docker manifest inspect node:20.11.0-bookworm-slim
# To refresh: docker manifest inspect node:20.11.0-bookworm-slim | jq '.manifests[0].digest'
FROM node:20.11.0-bookworm-slim@sha256:8ea90c4f037cc3c2f566eb46c53eaac005129113487eda4090058fe554578104 AS base

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    git \
    jq \
    python3 \
    python3-pip \
    python3-venv \
    grep \
    diffutils \
    coreutils \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install yq (mikefarah/yq) with SHA256 integrity verification (cycle-028 FR-3)
# Checksums from: https://github.com/mikefarah/yq/releases/tag/v4.40.5
# To refresh: download checksums file from release page, extract SHA-256 hashes
#   gh release download v4.40.5 --repo mikefarah/yq --pattern 'checksums' --output -
ARG YQ_VERSION=v4.40.5
ARG YQ_SHA256_AMD64=0d6aaf1cf44a8d18fbc7ed0ef14f735a8df8d2e314c4cc0f0242d35c0a440c95
ARG YQ_SHA256_ARM64=9431f0fa39a0af03a152d7fe19a86e42e9ff28d503ed4a70598f9261ec944a97
RUN arch=$(dpkg --print-architecture) && \
    case "$arch" in \
      amd64) yq_arch="amd64"; yq_sha256="${YQ_SHA256_AMD64}" ;; \
      arm64) yq_arch="arm64"; yq_sha256="${YQ_SHA256_ARM64}" ;; \
      *) echo "Unsupported architecture: $arch" && exit 1 ;; \
    esac && \
    curl -fsSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_${yq_arch}" \
      -o /usr/local/bin/yq && \
    echo "${yq_sha256}  /usr/local/bin/yq" | sha256sum -c - && \
    chmod +x /usr/local/bin/yq

# Disable npm lifecycle scripts globally
RUN npm config set ignore-scripts true

# Create non-root user
RUN groupadd -r evaluser && useradd -r -g evaluser -d /home/evaluser -s /bin/bash evaluser
RUN mkdir -p /home/evaluser /workspace /results /tmp/eval && \
    chown -R evaluser:evaluser /home/evaluser /workspace /results /tmp/eval

# Set controlled environment
ENV TZ=UTC
ENV LC_ALL=C
ENV HOME=/home/evaluser
ENV TMPDIR=/tmp/eval
ENV NODE_ENV=production
ENV NPM_CONFIG_IGNORE_SCRIPTS=true

# Clear any sensitive env vars that might leak from build
ENV AWS_ACCESS_KEY_ID=
ENV AWS_SECRET_ACCESS_KEY=
ENV ANTHROPIC_API_KEY=
ENV OPENAI_API_KEY=
ENV GITHUB_TOKEN=
ENV GH_TOKEN=

# Switch to non-root user
USER evaluser
WORKDIR /workspace

# Health check — verify tools are present
RUN bash --version && \
    git --version && \
    jq --version && \
    node --version && \
    python3 --version && \
    yq --version && \
    echo "All tools verified"

# Default: run eval harness
ENTRYPOINT ["/bin/bash"]
