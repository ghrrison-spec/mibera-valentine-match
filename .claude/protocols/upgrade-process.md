# Framework Upgrade Process

> **Protocol Version**: 1.0
> **Last Updated**: 2026-01-22
> **CLAUDE.md Reference**: Section "Helper Scripts"

Technical documentation for Loa framework upgrades.

## Overview

Loa uses a **Fetch → Validate → Migrate → Swap** pattern for framework updates. This ensures:

1. **Integrity**: System Zone changes are validated before applying
2. **Safety**: Atomic swaps prevent partial updates
3. **Traceability**: Clean git commits track every upgrade
4. **Reversibility**: Single-commit upgrades enable clean reverts

## Upgrade Workflow

### Stage 1: Integrity Check (BLOCKING in strict mode)

Verifies System Zone hasn't been modified:

```bash
# SHA256 checksums of all .claude/ files (except overrides/)
# Compared against .claude/checksums.json
```

**Enforcement Levels** (`.loa.config.yaml`):
- `strict`: Blocks execution on drift (recommended)
- `warn`: Warns but allows execution
- `disabled`: No integrity checks

### Stage 2: Fetch to Staging

Downloads upstream to isolated staging directory:

```bash
git clone --depth 1 --single-branch --branch main \
  https://github.com/0xHoneyJar/loa.git .claude_staging_repo

# Copy only .claude/ and .loa-version.json
cp -r .claude_staging_repo/.claude/* .claude_staging/
cp .claude_staging_repo/.loa-version.json .claude_staging/
rm -rf .claude_staging_repo
```

**Key**: `--depth 1` ensures no history pollution.

### Stage 3: Validation

Pre-flight checks on staged files:

1. **YAML Syntax**: All `.yaml` files validate
2. **Shell Syntax**: All `.sh` files pass `bash -n`
3. **Structure**: Required directories exist (skills/, commands/)

### Stage 4: Migrations (BLOCKING)

Schema migrations run when `schema_version` increases:

```bash
# From .loa-version.json
{
  "schema_version": 3,
  "migrations_applied": ["001_init_zones", "002_add_beads"]
}
```

Migrations in `migrations/*.sh` run sequentially. Failed migrations block the update.

### Stage 5: Atomic Swap

```bash
# Backup current
mv .claude .claude.backup.{timestamp}

# Swap in new
mv .claude_staging .claude

# On failure, rollback
mv .claude.backup.{timestamp} .claude
```

### Stage 6: Restore Overrides

User customizations in `.claude/overrides/` are preserved:

```bash
cp -r .claude.backup.{timestamp}/overrides/* .claude/overrides/
```

### Stage 7: Update Manifest

Updates `.loa-version.json`:

```json
{
  "framework_version": "1.4.0",
  "last_sync": "2026-01-22T00:00:00Z",
  "integrity": {
    "last_verified": "2026-01-22T00:00:00Z"
  }
}
```

### Stage 8: Generate New Checksums

Creates fresh `.claude/checksums.json` for integrity verification.

### Stage 9: Apply Stealth Mode

If `persistence_mode: stealth`, adds state files to `.gitignore`.

### Stage 10: Regenerate Config Snapshot

Updates `grimoires/loa/context/config_snapshot.json` for agent access.

### Stage 11: Create Atomic Commit (NEW in v1.4.0)

Creates a single git commit and version tag:

```bash
git add .claude .loa-version.json
git commit -m "chore(loa): upgrade framework v1.3.0 -> v1.4.0

- Updated .claude/ System Zone
- Preserved .claude/overrides/
- See: https://github.com/0xHoneyJar/loa/releases/tag/v1.4.0

Generated by Loa update.sh"

git tag -a "loa@v1.4.0" -m "Loa framework v1.4.0"
```

### Stage 12: Check for Grimoire Migration

Notifies if legacy `loa-grimoire/` path needs migration.

---

## Configuration Options

### .loa.config.yaml

```yaml
# Framework upgrade behavior
upgrade:
  # Create git commit after mount/upgrade (default: true)
  auto_commit: true

  # Create version tag after mount/upgrade (default: true)
  auto_tag: true

  # Conventional commit prefix (default: "chore")
  commit_prefix: "chore"
```

### Disable Auto-Commit

For users who prefer manual git control:

```yaml
upgrade:
  auto_commit: false
```

Or use the CLI flag:

```bash
.claude/scripts/update.sh --no-commit
```

### Stealth Mode

In stealth mode, no commits are created:

```yaml
persistence_mode: stealth
```

---

## Commit Message Format

### Mount (fresh install)

```
chore(loa): mount framework v1.4.0

- Installed Loa framework System Zone
- Created .claude/ directory structure
- See: https://github.com/0xHoneyJar/loa/releases/tag/v1.4.0

Generated by Loa mount-loa.sh
```

### Upgrade (existing install)

```
chore(loa): upgrade framework v1.3.0 -> v1.4.0

- Updated .claude/ System Zone
- Preserved .claude/overrides/
- See: https://github.com/0xHoneyJar/loa/releases/tag/v1.4.0

Generated by Loa update.sh
```

---

## Tag Format

Version tags use the format: `loa@v{VERSION}`

Examples:
- `loa@v1.3.0`
- `loa@v1.4.0`

**Query upgrade history**:
```bash
git tag -l 'loa@*'
```

**View specific upgrade**:
```bash
git show loa@v1.4.0
```

---

## Rollback Procedure

### Revert Last Upgrade

```bash
# If upgrade was the last commit
git revert HEAD

# This restores the previous .claude/ state
```

### Restore Specific Version

```bash
# Get version tag
git tag -l 'loa@*'

# Restore from tag
git checkout loa@v1.3.0 -- .claude

# Regenerate checksums
.claude/scripts/update.sh --force-restore
```

### Force Restore from Upstream

```bash
# Resets .claude/ to current upstream main
.claude/scripts/update.sh --force-restore
```

---

## Troubleshooting

### "SYSTEM ZONE INTEGRITY VIOLATION"

**Cause**: Files in `.claude/` were manually edited.

**Solutions**:
1. **Move edits to overrides**: `cp .claude/file .claude/overrides/file`
2. **Force restore**: `.claude/scripts/update.sh --force-restore`
3. **Temporarily bypass**: Set `integrity_enforcement: warn` in config

### "Failed to create commit"

**Cause**: Git state prevents commit (no changes, conflicts, etc.)

**Solutions**:
1. Check git status: `git status`
2. Use `--no-commit` flag: `.claude/scripts/update.sh --no-commit`
3. Commit manually after update

### "Tag already exists"

**Cause**: Same version was previously installed.

**Behavior**: Tag creation is skipped (safe), warning is logged.

### Dirty Working Tree Warning

**Cause**: Unstaged changes exist outside `.claude/`.

**Behavior**: Warning only - upgrade continues. Unstaged changes are NOT included in the upgrade commit.

---

## Environment Variables

| Variable | Description |
|----------|-------------|
| `LOA_UPSTREAM` | Override upstream repository URL |
| `LOA_BRANCH` | Override upstream branch (default: main) |

---

## Related Protocols

- `.claude/protocols/helper-scripts.md` - Full script documentation
- `.claude/protocols/preflight-integrity.md` - Integrity check details
- `.claude/protocols/constructs-integration.md` - Registry upgrades
