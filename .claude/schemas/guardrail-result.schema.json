{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://loa.dev/schemas/guardrail-result.schema.json",
  "title": "Loa Guardrail Result",
  "description": "Schema for guardrail trajectory log entries. Supports input_guardrail, danger_level, and handoff event types.",
  "type": "object",
  "required": ["type", "timestamp", "skill", "action"],
  "properties": {
    "type": {
      "type": "string",
      "enum": ["input_guardrail", "danger_level", "handoff"],
      "description": "Event type for the guardrail result"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of the event"
    },
    "session_id": {
      "type": "string",
      "description": "Session identifier for cross-session correlation"
    },
    "skill": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]+$",
      "description": "Skill identifier (kebab-case)"
    },
    "action": {
      "type": "string",
      "enum": ["PROCEED", "WARN", "BLOCK"],
      "description": "Guardrail action taken"
    },
    "latency_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Total guardrail check latency in milliseconds"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "type": { "const": "input_guardrail" } }
      },
      "then": {
        "properties": {
          "checks": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name", "status"],
              "properties": {
                "name": {
                  "type": "string",
                  "enum": ["pii_filter", "injection_detection", "relevance_check"],
                  "description": "Guardrail check name"
                },
                "status": {
                  "type": "string",
                  "enum": ["PASS", "WARN", "FAIL", "SKIP"],
                  "description": "Check result status"
                },
                "mode": {
                  "type": "string",
                  "enum": ["blocking", "parallel", "advisory"],
                  "description": "Execution mode for this check"
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "description": "Confidence score for relevance checks"
                },
                "redactions": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Number of PII redactions performed"
                },
                "score": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "description": "Injection detection score"
                },
                "patterns_matched": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "Injection patterns that matched"
                },
                "latency_ms": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Individual check latency"
                },
                "details": {
                  "type": "object",
                  "description": "Additional check-specific details"
                }
              }
            },
            "description": "Individual guardrail check results"
          },
          "input_size_bytes": {
            "type": "integer",
            "minimum": 0,
            "description": "Size of input being checked"
          },
          "redacted_input": {
            "type": "string",
            "description": "Redacted version of input (if PII found)"
          }
        }
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "danger_level" } }
      },
      "then": {
        "properties": {
          "level": {
            "type": "string",
            "enum": ["safe", "moderate", "high", "critical"],
            "description": "Danger level of the skill"
          },
          "mode": {
            "type": "string",
            "enum": ["interactive", "autonomous"],
            "description": "Execution mode context"
          },
          "override_used": {
            "type": "boolean",
            "description": "Whether --allow-high flag was used"
          },
          "reason": {
            "type": "string",
            "description": "Reason for the action taken"
          },
          "confirmation_required": {
            "type": "boolean",
            "description": "Whether user confirmation was required"
          },
          "confirmation_received": {
            "type": "boolean",
            "description": "Whether user confirmed (if required)"
          }
        },
        "required": ["level", "mode"]
      }
    },
    {
      "if": {
        "properties": { "type": { "const": "handoff" } }
      },
      "then": {
        "properties": {
          "from_agent": {
            "type": "string",
            "description": "Source agent/skill identifier"
          },
          "to_agent": {
            "type": "string",
            "description": "Target agent/skill identifier"
          },
          "handoff_type": {
            "type": "string",
            "enum": ["file_based", "memory", "direct"],
            "description": "Type of handoff mechanism"
          },
          "artifacts": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": { "type": "string" },
                "size_bytes": { "type": "integer" },
                "checksum": { "type": "string" }
              },
              "required": ["path"]
            },
            "description": "Artifacts transferred in handoff"
          },
          "context_preserved": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Context fields preserved across handoff"
          }
        },
        "required": ["from_agent", "to_agent", "handoff_type"]
      }
    }
  ],
  "examples": [
    {
      "type": "input_guardrail",
      "timestamp": "2026-02-03T10:30:00Z",
      "session_id": "abc123",
      "skill": "implementing-tasks",
      "action": "PROCEED",
      "latency_ms": 45,
      "checks": [
        { "name": "pii_filter", "status": "PASS", "redactions": 0, "latency_ms": 15 },
        { "name": "injection_detection", "status": "PASS", "score": 0.1, "latency_ms": 20 },
        { "name": "relevance_check", "status": "PASS", "confidence": 0.95, "mode": "parallel", "latency_ms": 10 }
      ]
    },
    {
      "type": "danger_level",
      "timestamp": "2026-02-03T10:30:01Z",
      "session_id": "abc123",
      "skill": "deploying-infrastructure",
      "action": "BLOCK",
      "level": "high",
      "mode": "autonomous",
      "override_used": false,
      "reason": "high-risk skills blocked in autonomous mode without --allow-high"
    },
    {
      "type": "handoff",
      "timestamp": "2026-02-03T10:35:00Z",
      "session_id": "abc123",
      "skill": "implementing-tasks",
      "action": "PROCEED",
      "from_agent": "implementing-tasks",
      "to_agent": "reviewing-code",
      "handoff_type": "file_based",
      "artifacts": [
        { "path": "grimoires/loa/a2a/sprint-1/reviewer.md", "size_bytes": 2048 }
      ],
      "context_preserved": ["sprint_id", "task_list", "commit_hash"]
    }
  ]
}
